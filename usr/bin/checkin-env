#!/usr/bin/env python
# vim: ft=python
# Checkin current state of virtualenv
import os
import sys
import re
from subprocess import Popen, PIPE

PYTHON=sys.executable
NEED_SHELL = True

def bt(cmd_str):
    proc = Popen(cmd_str,
                 stdout = PIPE,
                 stderr = PIPE,
                 shell = NEED_SHELL)
    stdout, stderr = proc.communicate()
    if proc.returncode != 0:
        raise RuntimeError('Error running %s\n%s' % (cmd_str, stderr))
    return stdout


def main():
    msg = ' '.join(sys.argv[1:])
    if msg == '':
        raise RuntimeError('Need commit message on command line')
    venv_dir = os.environ.get('VIRTUAL_ENV')
    if venv_dir is None:
        raise RuntimeError('Are we in a virtualenv?')
    os.chdir(venv_dir)
    bt('git add .')
    bt('git commit -m "%s"' % msg)


if __name__ == '__main__':
    main()
